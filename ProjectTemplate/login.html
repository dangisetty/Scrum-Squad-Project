<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Login | Scrum Squad</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <!-- NAVBAR -->
    <div class="navbar">
      <div class="navbar-title">Scrum Squad</div>
      <div class="navbar-links">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="login.html">Login</a>
        <a href="feed.html">Feed</a>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="card" id="loginCard">
        <h1>Welcome Back</h1>
        <p id="loginMsg">Please log in or create an account.</p>

        <form id="loginForm">
          <div class="form-group">
            <label for="login-username">Username</label>
            <input
              type="text"
              id="login-username"
              required
              autocomplete="username"
            />
          </div>
          <div class="form-group">
            <label for="login-password">Password</label>
            <input
              type="password"
              id="login-password"
              required
              autocomplete="current-password"
            />
          </div>
          <button
            type="submit"
            class="primary-btn"
            style="width: 100%; margin-top: 1rem"
          >
            Login
          </button>
        </form>

        <hr style="margin: 2rem 0" />

        <h2 style="margin-bottom: 0.5rem">Create Account</h2>
        <form id="signupForm">
          <div class="form-group">
            <label for="signup-username">Username</label>
            <input
              type="text"
              id="signup-username"
              required
              autocomplete="username"
            />
          </div>
          <div class="form-group">
            <label for="signup-password">Password</label>
            <input
              type="password"
              id="signup-password"
              required
              autocomplete="new-password"
            />
          </div>
          <div class="form-group">
            <label for="signup-displayName">Display Name (optional)</label>
            <input
              type="text"
              id="signup-displayName"
              autocomplete="nickname"
            />
          </div>
          <button
            type="submit"
            class="secondary-btn"
            style="width: 100%; margin-top: 1rem"
          >
            Sign Up
          </button>
        </form>
        <div id="authStatus" style="margin-top: 1rem; color: #b91c1c"></div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script src="JavaScript/notificationService.js"></script>
    <script src="JavaScript/authService.js"></script>

    <script>
      async function checkSession() {
        const res = await AuthService.whoami();
        if (res.ok && res.user) {
          document.getElementById("loginMsg").textContent =
            `Logged in as ${res.user.displayName || "User"}`;
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("signupForm").style.display = "none";
          document.getElementById("authStatus").innerHTML =
            `<button onclick="logout()" class='secondary-btn'>Logout</button>`;
          document.getElementById("authStatus").style.color = "#15803d";

          // Notification: already logged in
          if (window.NotificationService) {
            NotificationService.info(
              `You’re already logged in as ${res.user.displayName || res.user.username || "User"}.`,
              "feed.html",
            );
          }
        }
      }
      checkSession();

      document.getElementById("loginForm").onsubmit = async function (e) {
        e.preventDefault();
        const username = document.getElementById("login-username").value.trim();
        const password = document.getElementById("login-password").value;
        const res = await AuthService.login(username, password);

        if (res.ok) {
          document.getElementById("authStatus").style.color = "#15803d";
          document.getElementById("authStatus").textContent =
            "Login successful!";

          // Notification: login success
          if (window.NotificationService) {
            NotificationService.success(
              "Login successful! Redirecting you to the feed.",
              "feed.html",
            );
          }

          setTimeout(() => (window.location.href = "feed.html"), 800);
        } else {
          document.getElementById("authStatus").style.color = "#b91c1c";
          document.getElementById("authStatus").textContent =
            res.message || "Login failed.";

          // Notification: login fail
          if (window.NotificationService) {
            NotificationService.error(
              res.message || "Login failed. Please try again.",
            );
          }
        }
      };

      document.getElementById("signupForm").onsubmit = async function (e) {
        e.preventDefault();
        const username = document
          .getElementById("signup-username")
          .value.trim();
        const password = document.getElementById("signup-password").value;
        const displayName = document
          .getElementById("signup-displayName")
          .value.trim();
        const res = await AuthService.signup(username, password, displayName);

        if (res.ok) {
          document.getElementById("authStatus").style.color = "#15803d";
          document.getElementById("authStatus").textContent =
            "Account created! Logging in...";

          // Notification: signup success
          if (window.NotificationService) {
            NotificationService.success(
              "Account created! Redirecting you to the feed.",
              "feed.html",
            );
          }

          setTimeout(() => (window.location.href = "feed.html"), 800);
        } else {
          document.getElementById("authStatus").style.color = "#b91c1c";
          document.getElementById("authStatus").textContent =
            res.message || "Signup failed.";

          // Notification: signup fail
          if (window.NotificationService) {
            NotificationService.error(
              res.message || "Signup failed. Please try again.",
            );
          }
        }
      };

      async function logout() {
        await AuthService.logout();

        // Notification: logout
        if (window.NotificationService) {
          NotificationService.info("You’ve been logged out.");
        }

        window.location.reload();
      }
    </script>

    <!-- FOOTER -->
    <div class="footer">
      © 2026 Scrum Squad Project Team. All rights reserved.
    </div>
  </body>
</html>
